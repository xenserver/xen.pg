From 266aa192930db45d5de3b9c09d21ba809de3b868 Mon Sep 17 00:00:00 2001
From: Sergey Dyasli <sergey.dyasli@citrix.com>
Date: Thu, 29 Mar 2018 16:47:06 +0100
Subject: [PATCH] x86/vvmx: set CR4 before CR0

Otherwise hvm_set_cr0() will check the wrong CR4 bits (L1 instead of L2
and vice-versa).

Signed-off-by: Sergey Dyasli <sergey.dyasli@citrix.com>
---
 xen/arch/x86/hvm/vmx/vvmx.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/xen/arch/x86/hvm/vmx/vvmx.c b/xen/arch/x86/hvm/vmx/vvmx.c
index 028d820522..d4fd15b746 100644
--- a/xen/arch/x86/hvm/vmx/vvmx.c
+++ b/xen/arch/x86/hvm/vmx/vvmx.c
@@ -1075,8 +1075,8 @@ static void load_shadow_guest_state(struct vcpu *v)
 
     nvcpu->guest_cr[0] = get_vvmcs(v, CR0_READ_SHADOW);
     nvcpu->guest_cr[4] = get_vvmcs(v, CR4_READ_SHADOW);
-    hvm_set_cr0(get_vvmcs(v, GUEST_CR0), 1);
     hvm_set_cr4(get_vvmcs(v, GUEST_CR4), 1);
+    hvm_set_cr0(get_vvmcs(v, GUEST_CR0), 1);
     hvm_set_cr3(get_vvmcs(v, GUEST_CR3), 1);
 
     control = get_vvmcs(v, VM_ENTRY_CONTROLS);
@@ -1265,8 +1265,8 @@ static void load_vvmcs_host_state(struct vcpu *v)
         __vmwrite(vmcs_h2g_field[i].guest_field, r);
     }
 
-    hvm_set_cr0(get_vvmcs(v, HOST_CR0), 1);
     hvm_set_cr4(get_vvmcs(v, HOST_CR4), 1);
+    hvm_set_cr0(get_vvmcs(v, HOST_CR0), 1);
     hvm_set_cr3(get_vvmcs(v, HOST_CR3), 1);
 
     control = get_vvmcs(v, VM_EXIT_CONTROLS);
-- 
2.14.1

