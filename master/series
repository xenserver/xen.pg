#
# XenServer patch queue on top of xen.git
#    Upstream at git://xenbits.xen.org/xen.git
#
# In an effort to reduce future work of upgrading Xen versions, all patches in
# this queue require a justification as to why they can't/won't be upstreamed,
# with the implication that everything else should be upstreamed.
#
# If in any doubt, the ring0 patch queue maintainer will be happy to help.
#
# All patches should follow the guidelines listed here:
#       http://wiki.xen.org/wiki/Submitting_Xen_Patches
# in particular with respect to a description and S-o-b lines, with the
# exception of temporary debugging patches, which should contain at least a CA
# reference.
#
# Overview of sections:
# * XenServer build system integration.
#       **Minimal Upstream makefile hacks**
# * Upstream patches.
#       Verbatim patches from upstream, possibly with tweaks because of backporting
# * Patches for upstream.
#       Most patches should be in this section, especially new ones.  By using
#       this section, you are assuming responsibility for getting the patches
#       included upstream, and will be periodically chased by the patch queue
#       maintainer.
# * Un-upstreamable patches.
#       Default tweaks, etc.  Should be minimal.
# * Technical debt.
#       Legacy patches brought forward from the past.  This section should
#       never increase, and should progressively decrease.  **Remove when empty**
# * Debugging patches.
#       Temporary debugging patches, which must contain a CA reference.  Before
#       closing a ticket, you are expected to remove debugging patches.

################################################################################
# XenServer build system integration
#
build-tweaks.patch # Tweak version string, start-of-day banner and changeset
autoconf-libjson.patch

configure-build.patch # Configuration files for the build, including cached ./configure
changeset-info.patch
xenserver-configuration.patch
coverity-model.patch

################################################################################
# Upstream patches
#
# Naming scheme: backport-<12 digit SHA>.patch # [*] <UTC TIMESTAMP> - <Commit subject>
#   A '*' indicates a patch which should be suggested for backport upstream

# Patches from master
backport-91c3e3dc91d6.patch #   2019-03-12 12:57:13 - tools/xentop: Display '-' when stats are not available.
backport-65c165d6595f.patch #   2019-03-12 13:57:13 - x86/xstate: Don't special case feature collection
backport-af9a3de69f8b.patch #   2019-03-12 18:14:25 - microcode/intel: use union to get fields without shifting and masking
backport-787619a0640e.patch #   2019-03-14 15:38:39 - tools: re-sync CPUID leaf 7 tables
backport-905d7340f6d0.patch #   2019-04-01 16:42:59 - xen/sched: Remove d->is_pinned
backport-44f3c3cdd315.patch #   2019-04-03 15:14:30 - x86/altp2m: treat view 0 as the hostp2m in p2m_get_mem_access()
backport-704caeb93c52.patch #   2019-04-05 09:16:16 - hvmloader: add SMBIOS type 2 info for customized string
backport-40a4a9d72d16.patch #   2019-04-05 09:21:38 - viridian: add init hooks
backport-e7a9b5e72f26.patch #   2019-04-05 09:22:13 - viridian: separately allocate domain and vcpu structures
backport-d27a69a29a4f.patch #   2019-04-05 09:24:13 - viridian: use stack variables for viridian_vcpu and viridian_domain...
backport-a204e6f8e744.patch #   2019-04-05 09:24:47 - viridian: make 'fields' struct anonymous...
backport-80aaa19e0307.patch #   2019-04-05 09:26:14 - viridian: extend init/deinit hooks into synic and time modules
backport-9203661ebb3c.patch #   2019-04-05 09:28:18 - viridian: add missing context save helpers into synic and time modules
backport-386b3365221d.patch #   2019-04-05 09:29:19 - viridian: use viridian_map/unmap_guest_page() for reference tsc page
backport-aeaa5d8b7a7c.patch #   2019-04-05 09:30:52 - viridian: stop directly calling viridian_time_ref_count_freeze/thaw()...
backport-a85089d0ef57.patch #   2019-04-05 09:31:40 - viridian: add implementation of synthetic interrupt MSRs
backport-26fba3c85571.patch #   2019-04-05 09:32:20 - viridian: add implementation of synthetic timers
backport-fda96b7382ea.patch #   2019-04-05 09:32:57 - viridian: add implementation of the HvSendSyntheticClusterIpi hypercall
backport-013896cb8b2f.patch #   2019-04-05 11:09:08 - x86/msr: Fix handling of MSR_AMD_PATCHLEVEL/MSR_IA32_UCODE_REV
backport-8228577ad1ba.patch #   2019-04-09 19:34:41 - x86/hvm: Fix altp2m_op hypercall continuations
backport-9b757bdc1794.patch #   2019-05-13 10:35:37 - x86/boot: Don't leak the module_map allocation in __start_xen()
backport-9abcac7ff145.patch #   2019-05-28 14:10:36 - x86/altp2m: cleanup p2m_altp2m_lazy_copy
backport-df4e4cafd28d.patch #   2019-05-29 14:39:28 - x86/altp2m: Fix style errors introduced with c/s 9abcac7ff
backport-b144cf45d50b.patch #   2019-05-31 10:40:52 - x86/vhpet: avoid 'small' time diff test on resume
backport-e2105180f99d.patch #   2019-05-31 19:11:29 - x86/spec-ctrl: Knights Landing/Mill are retpoline-safe
backport-082f070c063e.patch #   2019-06-11 16:21:34 - x86/AMD: make use of CPUID leaf 0xb when available
backport-63dc4209d242.patch #   2019-06-12 15:54:29 - x86/boot: Drop vestigial support for pre-SIPI APICs
backport-97fcef9d44af.patch #   2019-06-17 16:35:41 - x86/IO-APIC: dump full destination ID in x2APIC mode
backport-2ac48fd52d84.patch #   2019-06-17 16:38:35 - x86/x2APIC: tighten check in cluster mode IPI sending
backport-e0fbf3bf9871.patch #   2019-06-18 15:33:53 - x86/AMD: correct certain Fam17 checks
backport-5c2926f576c9.patch #   2019-06-18 15:34:51 - x86/AMD: limit C1E disable family range
backport-6ff560f7f1f2.patch #   2019-06-18 15:35:35 - x86/SMP: don't try to stop already stopped CPUs
backport-260acc521db4.patch #   2019-06-18 15:47:52 - x86/clear_page: Update clear_page_sse2() after dropping 32bit Xen
backport-7d161f653755.patch #   2019-06-19 19:54:22 - x86/svm: Fix svm_vmcb_dump() when used in current context
backport-560cf418c845.patch #   2019-06-25 16:32:37 - x86/mcheck: allow varying bank counts per CPU
backport-19b2006a8950.patch #   2019-06-25 16:33:40 - x86/mcheck: replace remaining uses of __get_cpu_var()
backport-62b8949e9dde.patch #   2019-06-25 16:34:11 - x86: replace remaining uses of __get_cpu_var()
backport-1bef4b1efd40.patch #   2019-06-25 16:34:53 - drop __get_cpu_var() and __get_cpu_ptr()

################################################################################
# Patches for upstream
#

# v7 late ucode series from Chao Gao (Intel)
0001-misc-xen-ucode-Upload-a-microcode-blob-to-the-hyperv.patch
0002-microcode-intel-extend-microcode_update_match.patch
0003-microcode-introduce-a-global-cache-of-ucode-patch.patch
0004-microcode-remove-struct-ucode_cpu_info.patch
0005-microcode-remove-pointless-cpu-parameter.patch
0006-microcode-split-out-apply_microcode-from-cpu_request.patch
0007-microcode-intel-Writeback-and-invalidate-caches-befo.patch
0008-x86-microcode-Synchronize-late-microcode-loading.patch
0009-microcode-remove-microcode_update_lock.patch
0010-x86-microcode-always-collect_cpu_info-during-boot.patch
# local fixes/changes (to be applied onto v7)
0002-microcode-rename-tool-to-xen-microcode.patch
0003-xen-microcode-add-information-about-currently-loaded.patch
0004-microcode-add-sequential-application-policy.patch
0007-microcode-update-raw-cpuid-policy-after-a-successful.patch
0001-microcode-remove-panic-calls.patch

detect-nehalem-c-state.patch # malcolmc
quirk-hp-gen8-rmrr.patch # malcolmc
quirk-pci-phantom-function-devices.patch # malcolmc

# Hpet improvements v5
0001-x86-hpet-Pre-cleanup.patch
0002-x86-hpet-Use-singe-apic-vector-rather-than-irq_descs.patch
0003-x86-hpet-Post-cleanup.patch

0002-libxc-retry-shadow-ops-if-EBUSY-is-returned.patch

# Grant perf improvements
avoid-gnt-unmap-tlb-flush-if-not-accessed.patch

# Further MB2/EFI fixes
0002-efi-Ensure-incorrectly-typed-runtime-services-get-ma.patch
0001-x86-time-Don-t-use-EFI-s-GetTime-call.patch
0001-efi-Workaround-page-fault-during-runtime-service.patch

0001-x86-HVM-Avoid-cache-flush-operations-during-hvm_load.patch # rossla - CA-168080
0001-libxl-Don-t-insert-PCI-device-into-xenstore-for-HVM-.patch # rossla - CA-168029

# PoD extra mitigations
0001-x86-PoD-Command-line-option-to-prohibit-any-PoD-oper.patch

fail-on-duplicate-symbol.patch
livepatch-ignore-duplicate-new.patch
default-log-level-info.patch

# Reduce use of __LINE__
0001-lib-Add-a-generic-implementation-of-current_text_add.patch
0002-sched-Remove-dependency-on-__LINE__-for-release-buil.patch

# btrfs support for PV guests
pygrub-Ignore-GRUB2-if-statements.patch
libfsimage-Add-support-for-btrfs.patch

0001-xen-domctl-Implement-a-way-to-retrieve-a-domains-nom.patch

quiet-broke-irq-affinity.patch # rossla

quirk-intel-purley.patch # rossla

# nested virt
0001-x86-vvmx-set-CR4-before-CR0.patch

# MSR policy
0001-x86-msr-Blacklist-various-MSRs-which-guests-definite.patch

# AVX-512
0004-x86-cpuid-Enable-new-SSE-AVX-AVX512-cpu-features.patch
0001-Hide-AVX-512-from-guests-by-default.patch

# memory scrubbing
0001-common-page_alloc-don-t-idle-scrub-before-microcode-.patch

################################################################################
# Un-upstreamable patches
#
xen-tweak-cmdline-defaults.patch
xen-tweak-debug-overhead.patch
tweak-iommu-policy.patch
disable-core-parking.patch

0001-Allocate-space-in-structs-pre-emptively-to-increase-.patch

################################################################################
# Technical debt
#

# xen debt
livepatch-payload-in-header.patch
xen-define-offsets-for-kdump.patch
xen-scheduler-auto-privdom-weight.patch
xen-hvm-disable-tsc-ramping.patch
xen-default-cpufreq-governor-to-performance-on-intel.patch
xen-override-caching-cp-26562.patch
0001-Partially-revert-08754333892-hvmloader-limit-CPUs-ex.patch
0001-x86-pv-silently-discard-writes-into-MSR_AMD64_LS_CFG.patch # Remove when SSBD handling on AMD is reworked

# libxc debt
revert-ca2eee92df44.patch # 2008-09-30 09:14:54 - x86, hvm: Expose host core/HT topology to HVM guests - needs removing in a migrate-safe way.
libxc-stubs-hvm_check_pvdriver.patch

# pygrub debt
pygrub-add-default-and-extra-args.patch
pygrub-always-boot-default.patch
pygrub-friendly-no-fs.patch
pygrub-image-max-size.patch
pygrub-default-xenmobile-kernel.patch
pygrub-blacklist-support.patch

# BIOS debt
oem-bios-xensource.patch # Can probably all be discarded
oem-bios-magic-from-xenstore.patch # Need to tweak, but should be upstreamed

# misc debt
misc-log-guest-consoles.patch
fix-ocaml-libs.patch
ocaml-cpuid-helpers.patch

# xentop debt
xentop-vbd3.patch

# mixed between components
mixed-domain-runstates.patch
mixed-xc-sockets-per-core.patch
xenguest.patch
xen-vmdebug.patch

oxenstore-censor-sensitive-data.patch
oxenstore-large-packets.patch

# vGPU
nvidia-vga.patch

# workspace pod debt
hvmloader-disable-pci-option-rom-loading.patch

# Nested virt tweaking knobs
xen-force-software-vmcs-shadow.patch
0001-x86-vvmx-add-initial-PV-EPT-support-in-L0.patch
use-msr-ll-instead-of-vmcs-efer.patch

add-pv-iommu-headers.patch
add-pv-iommu-local-domain-ops.patch
add-pv-iommu-foreign-support.patch
add-pv-iommu-premap-m2b-support.patch
upstream-pv-iommu-tools.patch

# Intel GVT-g debt
allow-rombios-pci-config-on-any-host-bridge.patch
0007-hypercall-XENMEM_get_mfn_from_pfn.patch # Remove when PV-IOMMU code merged
gvt-g-hvmloader+rombios.patch # Intel to upstream

# VM Introspection Extensions
xen-introduce-cmdline-to-control-introspection-extensions.patch
xen-domctl-set-privileged-domain.patch
xen-reexecute-instn-under-monitor-trap.patch
revert-x86-mm-suppress-vm_events-caused-by-page-walks.patch
xen-emulate-Bypass-the-emulator-if-emulation-fails.patch
xen-introspection-pause.patch
xen-always-enable-altp2m-external-mode.patch

# Common Criteria
0001-cc-memory-scrubbing.patch

# Live microcode loading additions
0001-x86-add-XEN_SYSCTL_spec_ctrl.patch
0002-x86-add-xen-spec-ctrl-utility.patch

################################################################################
# Debugging patches
#
