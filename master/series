#
# XenServer patch queue on top of xen.git
#    Upstream at git://xenbits.xen.org/xen.git
#
# In an effort to reduce future work of upgrading Xen versions, all patches in
# this queue require a justification as to why they can't/won't be upstreamed,
# with the implication that everything else should be upstreamed.
#
# If in any doubt, the ring0 patch queue maintainer will be happy to help.
#
# All patches should follow the guidelines listed here:
#       http://wiki.xen.org/wiki/Submitting_Xen_Patches
# in particular with respect to a description and S-o-b lines, with the
# exception of temporary debugging patches, which should contain at least a CA
# reference.
#
# Overview of sections:
# * XenServer build system integration.
#       **Minimal Upstream makefile hacks**
# * Upstream patches.
#       Verbatim patches from upstream, possibly with tweaks because of backporting
# * Patches for upstream.
#       Most patches should be in this section, especially new ones.  By using
#       this section, you are assuming responsibility for getting the patches
#       included upstream, and will be periodically chased by the patch queue
#       maintainer.
# * Un-upstreamable patches.
#       Default tweaks, etc.  Should be minimal.
# * Technical debt.
#       Legacy patches brought forward from the past.  This section should
#       never increase, and should progressively decrease.  **Remove when empty**
# * Debugging patches.
#       Temporary debugging patches, which must contain a CA reference.  Before
#       closing a ticket, you are expected to remove debugging patches.

################################################################################
# XenServer build system integration
#
build-tweaks.patch # Tweak version string, start-of-day banner and changeset
autoconf-libjson.patch

configure-build.patch # Configuration files for the build, including cached ./configure
changeset-info.patch
xenserver-configuration.patch
coverity-model.patch

################################################################################
# Upstream patches
#
# Naming scheme: backport-<12 digit SHA>.patch # [*] <UTC TIMESTAMP> - <Commit subject>
#   A '*' indicates a patch which should be suggested for backport upstream

backport-f06d11d5a833.patch #   2019-11-15 13:17:26 - AMD/IOMMU: restore DTE fields in amd_iommu_setup_domain_device()
backport-a0bfdf64d9d1.patch #   2019-11-20 12:37:59 - x86/cpuid: Fix Lisbon/Magny-Cours Opterons WRT SSSE3/SSE4A
backport-534f9e29ce28.patch #   2019-11-20 16:10:59 - efi: do not use runtime services table with efi=no-rs
backport-77beba7c921a.patch #   2019-11-25 10:58:27 - x86/mm: Adjust linear uses / entries when a page loses validation
backport-48599114d3ca.patch #   2019-11-26 13:16:09 - x86/domctl: have XEN_DOMCTL_getpageframeinfo3 preemptible
backport-5530782cfe70.patch #   2019-11-26 13:17:45 - EFI: fix "efi=attr=" handling
backport-195b79a97e67.patch #   2019-11-27 11:28:24 - AMD/IOMMU: honour IR setting while pre-filling DTEs
backport-72580a8d3c7a.patch #   2019-11-27 12:53:41 - x86/microcode: refuse to load the same revision ucode
backport-5655ce8b1ec2.patch #   2019-11-28 14:14:03 - x86/IRQ: make internally used IRQs also honor the pending EOI stack
backport-aaf8839fdf8b.patch #   2019-11-29 16:08:20 - console: avoid buffer overflow in guest_console_write()
backport-0ef3ad971275.patch #   2019-11-29 16:09:16 - console: avoid buffer overrun in guest_console_write()

xsa308.patch # x86/vtx: Work around SingleStep + STI/MovSS VMEntry failures
xsa309.patch # x86/mm: Don't reset linear_pt_count on partial validation
xsa310-1.patch # x86/mm: Set old_guest_table when destroying vcpu pagetables
xsa310-2.patch # x86/mm: alloc/free_lN_table: Retain partial_flags on -EINTR
xsa310-3.patch # x86/mm: relinquish_memory: Grab an extra type ref when setting PGT_partial
xsa311.patch # AMD/IOMMU: Cease using a dynamic height for the IOMMU pagetables

0001-passthrough-simplify-locking-and-logging.patch

################################################################################
# Patches for upstream
#

# late ucode loading fixes/changes
0007-microcode-intel-Writeback-and-invalidate-caches-befo.patch
0003-xen-microcode-add-information-about-currently-loaded.patch
0004-microcode-add-sequential-application-policy.patch
0007-microcode-update-raw-cpuid-policy-after-a-successful.patch
0001-microcode-remove-panic-calls.patch

detect-nehalem-c-state.patch # malcolmc
quirk-hp-gen8-rmrr.patch # malcolmc
quirk-pci-phantom-function-devices.patch # malcolmc

# Hpet improvements v5
0001-x86-hpet-Pre-cleanup.patch
0002-x86-hpet-Use-singe-apic-vector-rather-than-irq_descs.patch
0003-x86-hpet-Post-cleanup.patch

0002-libxc-retry-shadow-ops-if-EBUSY-is-returned.patch

# Grant perf improvements
avoid-gnt-unmap-tlb-flush-if-not-accessed.patch

# Further MB2/EFI fixes
0002-efi-Ensure-incorrectly-typed-runtime-services-get-ma.patch
0001-x86-time-Don-t-use-EFI-s-GetTime-call.patch
0001-efi-Workaround-page-fault-during-runtime-service.patch

0001-x86-HVM-Avoid-cache-flush-operations-during-hvm_load.patch # rossla - CA-168080
0001-libxl-Don-t-insert-PCI-device-into-xenstore-for-HVM-.patch # rossla - CA-168029

# PoD extra mitigations
0001-x86-PoD-Command-line-option-to-prohibit-any-PoD-oper.patch

livepatch-ignore-duplicate-new.patch
default-log-level-info.patch

# Reduce use of __LINE__
0001-lib-Add-a-generic-implementation-of-current_text_add.patch
0002-sched-Remove-dependency-on-__LINE__-for-release-buil.patch

# btrfs support for PV guests
pygrub-Ignore-GRUB2-if-statements.patch
libfsimage-Add-support-for-btrfs.patch

0001-xen-domctl-Implement-a-way-to-retrieve-a-domains-nom.patch

quiet-broke-irq-affinity.patch # rossla

# MSR policy
0001-x86-msr-Blacklist-various-MSRs-which-guests-definite.patch

# AVX-512
0001-Hide-AVX-512-from-guests-by-default.patch

# memory scrubbing
0001-common-page_alloc-don-t-idle-scrub-before-microcode-.patch

0001-xsm-hide-detailed-Xen-version-from-unprivileged-gues.patch

0001-x86-e820-fix-640k-1M-region-reservation-logic.patch

################################################################################
# Un-upstreamable patches
#
xen-tweak-cmdline-defaults.patch
xen-tweak-debug-overhead.patch
tweak-iommu-policy.patch
disable-core-parking.patch

0001-Allocate-space-in-structs-pre-emptively-to-increase-.patch

0001-x86-mm-partially-revert-37201c62-make-logdirty-and-i.patch

################################################################################
# Technical debt
#

# xen debt
livepatch-payload-in-header.patch
xen-define-offsets-for-kdump.patch
xen-scheduler-auto-privdom-weight.patch
xen-hvm-disable-tsc-ramping.patch
xen-default-cpufreq-governor-to-performance-on-intel.patch
xen-override-caching-cp-26562.patch
0001-Partially-revert-08754333892-hvmloader-limit-CPUs-ex.patch
0001-x86-pv-silently-discard-writes-into-MSR_AMD64_LS_CFG.patch # Remove when SSBD handling on AMD is reworked

# libxc debt
revert-ca2eee92df44.patch # 2008-09-30 09:14:54 - x86, hvm: Expose host core/HT topology to HVM guests - needs removing in a migrate-safe way.
libxc-stubs-hvm_check_pvdriver.patch

# pygrub debt
pygrub-add-default-and-extra-args.patch
pygrub-always-boot-default.patch
pygrub-friendly-no-fs.patch
pygrub-image-max-size.patch
pygrub-default-xenmobile-kernel.patch
pygrub-blacklist-support.patch

# BIOS debt
oem-bios-xensource.patch # Can probably all be discarded
oem-bios-magic-from-xenstore.patch # Need to tweak, but should be upstreamed

# misc debt
misc-log-guest-consoles.patch
fix-ocaml-libs.patch
0005-x86-msr-Expose-cpu_has_tsx_ctrl-via-MSR_ARCH_CAPS.patch
ocaml-cpuid-helpers.patch

# xentop debt
xentop-vbd3.patch

# mixed between components
mixed-domain-runstates.patch
mixed-xc-sockets-per-core.patch
xenguest.patch
xen-vmdebug.patch

oxenstore-censor-sensitive-data.patch
oxenstore-large-packets.patch

# vGPU
nvidia-vga.patch

# workspace pod debt
hvmloader-disable-pci-option-rom-loading.patch

# Nested virt tweaking knobs
xen-force-software-vmcs-shadow.patch
0001-x86-vvmx-add-initial-PV-EPT-support-in-L0.patch
use-msr-ll-instead-of-vmcs-efer.patch

add-pv-iommu-headers.patch
add-pv-iommu-local-domain-ops.patch
add-pv-iommu-foreign-support.patch
add-pv-iommu-premap-m2b-support.patch
upstream-pv-iommu-tools.patch

# Intel GVT-g debt
allow-rombios-pci-config-on-any-host-bridge.patch
0007-hypercall-XENMEM_get_mfn_from_pfn.patch # Remove when PV-IOMMU code merged
gvt-g-hvmloader+rombios.patch # Intel to upstream

# VM Introspection Extensions
xen-introduce-cmdline-to-control-introspection-extensions.patch
xen-domctl-set-privileged-domain.patch
xen-reexecute-instn-under-monitor-trap.patch
revert-x86-mm-suppress-vm_events-caused-by-page-walks.patch
xen-emulate-Bypass-the-emulator-if-emulation-fails.patch
xen-introspection-pause.patch
xen-always-enable-altp2m-external-mode.patch

# Common Criteria
0001-cc-memory-scrubbing.patch

# Live microcode loading additions
0001-x86-add-XEN_SYSCTL_spec_ctrl.patch
0002-x86-add-xen-spec-ctrl-utility.patch

################################################################################
# Hotfix patches
#
backport-5e08f5f56c99.patch #   2020-01-29 14:06:10 - x86/suspend: disable watchdog before calling console_start_sync()
xsa313-1.patch
xsa313-2.patch
backport-7442006b9f09.patch #   2019-12-11 13:06:18 - x86+Arm32: make find_next_{,zero_}bit() have well defined behavior
xsa316xsa316-xen.patch
xsa316-2.patch
0001-x86-spec-ctrl-CPUID-MSR-definitions-for-Special-Regi.patch # XSA-320 / SRBDS
0002-x86-spec-ctrl-Mitigate-the-Special-Register-Buffer-D.patch # XSA-320 / SRBDS
xsa317.patch
xsa319.patch
xsa328-xsa328-4.13-1.patch
xsa328-xsa328-4.13-2.patch
xsa321-xsa321-4.13-1.patch
xsa321-xsa321-4.13-2.patch
xsa321-xsa321-4.13-3.patch
xsa321-xsa321-4.13-4.patch
xsa321-xsa321-4.13-5.patch
xsa321-xsa321-4.13-6.patch
xsa321-xsa321-4.13-7.patch
xsa333.patch # x86/pv: Handle the Intel-specific MSR_MISC_ENABLE correctly
xsa336.patch # x86/vpt: fix race when migrating timers between vCPUs
xsa337xsa337-4.13-1.patch # x86/msi: get rid of read_msi_msg
xsa337xsa337-4.13-2.patch # x86/MSI-X: restrict reading of table/PBA bases from BAR
xsa338.patch # evtchn: relax port_is_valid()
xsa339.patch # x86/pv: Avoid double exception injection
xsa340.patch # xen/evtchn: Add missing barriers when accessing/allocating an event channel
xsa342-4.13.patch # evtchn/x86: enforce correct upper limit for 32-bit guests
