#
# XenServer patch queue on top of xen.git
#    Upstream at git://xenbits.xen.org/xen.git
#
# In an effort to reduce future work of upgrading Xen versions, all patches in
# this queue require a justification as to why they can't/won't be upstreamed,
# with the implication that everything else should be upstreamed.
#
# If in any doubt, the ring0 patch queue maintainer will be happy to help.
#
# All patches should follow the guidelines listed here:
#       http://wiki.xen.org/wiki/Submitting_Xen_Patches
# in particular with respect to a description and S-o-b lines, with the
# exception of temporary debugging patches, which should contain at least a CA
# reference.
#
# Overview of sections:
# * XenServer build system integration.
#       **Minimal Upstream makefile hacks**
# * Upstream patches.
#       Verbatim patches from upstream, possibly with tweaks because of backporting
# * Patches for upstream.
#       Most patches should be in this section, especially new ones.  By using
#       this section, you are assuming responsibility for getting the patches
#       included upstream, and will be periodically chased by the patch queue
#       maintainer.
# * Un-upstreamable patches.
#       Default tweaks, etc.  Should be minimal.
# * Technical debt.
#       Legacy patches brought forward from the past.  This section should
#       never increase, and should progressively decrease.  **Remove when empty**
# * Debugging patches.
#       Temporary debugging patches, which must contain a CA reference.  Before
#       closing a ticket, you are expected to remove debugging patches.

################################################################################
# XenServer build system integration
#
build-tweaks.patch # Tweak version string, start-of-day banner and changeset
autoconf-libjson.patch

configure-build.patch # Configuration files for the build, including cached ./configure
changeset-info.patch
xenserver-configuration.patch
coverity-model.patch

################################################################################
# Upstream patches
#
# Naming scheme: backport-<12 digit SHA>.patch # [*] <UTC TIMESTAMP> - <Commit subject>
#   A '*' indicates a patch which should be suggested for backport upstream
revert-eval-nospec.patch # Breaks livepatch build

backport-b0000b128adb.patch #   2019-09-17 15:09:50 - sched: populate cpupool0 only after all cpus are up
backport-73d1d61fa9de.patch #   2019-09-24 16:10:06 - sched: remove cpu from pool0 before removing it
backport-f855dd962523.patch #   2019-09-24 16:11:02 - sched: add minimalistic idle scheduler for free cpus
backport-d07bdb43f253.patch #   2019-09-24 16:11:38 - sched: switch to debugtrace in cpupool handling
backport-b6656e6aa4dd.patch #   2019-09-25 14:52:53 - sched: fix freeing per-vcpu data in sched_move_domain()
backport-f28c4c4c10bd.patch #   2019-09-26 17:04:09 - sched: don't let XEN_RUNSTATE_UPDATE leak into vcpu_runstate_get()
backport-ddc5a85fbcfb.patch #   2019-09-26 17:06:07 - x86/shim: fix ballooning down the guest
backport-19049f8d796a.patch #   2019-09-27 13:03:42 - sched: fix locking in a653sched_free_vdata()
backport-66c543cc986a.patch #   2019-09-27 13:04:29 - sched: rework and rename vcpu_force_reschedule()
backport-220f89505e77.patch #   2019-09-27 13:11:35 - x86/microcode: split out apply_microcode() from cpu_request_microcode()
backport-c6f4df21580b.patch #   2019-09-27 13:12:34 - x86/microcode: unify ucode loading during system bootup and resuming
backport-c2b276501945.patch #   2019-09-27 13:18:10 - x86/microcode: reduce memory allocation and copy when creating a patch
backport-8dd4dfa92d62.patch #   2019-09-27 13:18:57 - x86/microcode: Synchronize late microcode loading
backport-487b49e08ab1.patch #   2019-09-27 13:19:38 - x86/microcode: remove microcode_update_lock
backport-6cc3f5e106c6.patch #   2019-09-27 14:05:07 - xen/sched: use new sched_unit instead of vcpu in scheduler interfaces
backport-f9634b2d90b8.patch #   2019-09-27 14:15:39 - xen/sched: move per-vcpu scheduler private data pointer to sched_unit
backport-141db7fd4d2d.patch #   2019-09-27 14:16:53 - xen/sched: build a linked list of struct sched_unit
backport-d62fefa4d459.patch #   2019-09-27 14:17:30 - xen/sched: introduce struct sched_resource
backport-110f57a1ca89.patch #   2019-09-27 14:18:12 - xen/sched: let pick_cpu return a scheduler resource
backport-532c929207a7.patch #   2019-09-27 14:18:38 - xen/sched: switch schedule_data.curr to point at sched_unit
backport-207589dbacd4.patch #   2019-09-27 14:19:13 - xen/sched: move per cpu scheduler private data into struct sched_resource
backport-cc3186d57ed8.patch #   2019-09-27 14:19:48 - xen/sched: switch vcpu_schedule_lock to unit_schedule_lock
backport-8a04eaa8ea83.patch #   2019-09-27 14:20:13 - xen/sched: move some per-vcpu items to struct sched_unit
backport-e33fad6bf8d5.patch #   2019-09-27 14:20:53 - xen/sched: add scheduler helpers hiding vcpu
backport-2a1a44c2702a.patch #   2019-09-27 14:21:24 - xen/sched: rename scheduler related perf counters
backport-c7591deba829.patch #   2019-09-27 14:21:48 - xen/sched: switch struct task_slice from vcpu to sched_unit
backport-6533eb52e064.patch #   2019-09-27 14:22:11 - xen/sched: add is_running indicator to struct sched_unit
backport-eda016b81764.patch #   2019-09-27 14:29:52 - xen/sched: make null scheduler vcpu agnostic.
backport-f49fcc099818.patch #   2019-09-27 14:30:53 - xen/sched: make rt scheduler vcpu agnostic.
backport-98fcb63804ee.patch #   2019-09-27 14:31:15 - xen/sched: make credit scheduler vcpu agnostic.
backport-a76255b42665.patch #   2019-09-27 14:31:37 - xen/sched: make credit2 scheduler vcpu agnostic.
backport-2a404605e96d.patch #   2019-09-27 14:32:00 - xen/sched: make arinc653 scheduler vcpu agnostic.
backport-b218ad9f97f0.patch #   2019-09-27 14:32:22 - xen: add sched_unit_pause_nosync() and sched_unit_unpause()
backport-8d3c326f6756.patch #   2019-09-27 14:59:19 - xen: let vcpu_create() select processor
backport-224df9b002b9.patch #   2019-09-27 15:00:35 - xen/sched: use sched_resource cpu instead smp_processor_id in schedulers
backport-0566fbf52e27.patch #   2019-09-27 15:01:01 - xen/sched: switch schedule() from vcpus to sched_units
backport-67a6cafebdaf.patch #   2019-09-27 15:01:25 - xen/sched: switch sched_move_irqs() to take sched_unit as parameter
backport-4ef0e1fe967f.patch #   2019-09-27 15:01:56 - xen: switch from for_each_vcpu() to for_each_sched_unit()
backport-427709a9b283.patch #   2019-09-27 15:02:23 - xen/sched: add runstate counters to struct sched_unit
backport-197baceee47f.patch #   2019-09-27 15:03:07 - xen/sched: Change vcpu_migrate_*() to operate on schedule unit
backport-7a4e67111149.patch #   2019-09-27 15:03:31 - xen/sched: move struct task_slice into struct sched_unit
backport-7d5247cee21a.patch #   2019-10-02 11:25:05 - x86/crash: force unlock console before printing on kexec crash
backport-f534bc6821ea.patch #   2019-10-04 11:53:40 - xen/sched: add code to sync scheduling of all vcpus of a sched unit
backport-7c7b407e7772.patch #   2019-10-04 11:54:38 - xen/sched: introduce unit_runnable_state()
backport-f16c4ced3f1b.patch #   2019-10-04 11:55:14 - xen/sched: add support for multiple vcpus per sched unit where missing
backport-a9dd180cf831.patch #   2019-10-04 11:55:45 - xen/sched: modify cpupool_domain_cpumask() to be an unit mask
backport-c0db6570c44c.patch #   2019-10-04 11:56:27 - xen/sched: support allocating multiple vcpus into one sched unit
backport-6a4d4066756c.patch #   2019-10-04 11:56:55 - xen/sched: add a percpu resource index
backport-be9dde875792.patch #   2019-10-04 11:57:24 - xen/sched: add fall back to idle vcpu when scheduling unit
backport-ba7ff2c7bb01.patch #   2019-10-04 11:58:09 - xen/sched: make vcpu_wake() and vcpu_sleep() core scheduling aware
backport-b6eeeccf46d7.patch #   2019-10-04 11:58:49 - xen/sched: move per-cpu variable scheduler to struct sched_resource
backport-9b564c3c0643.patch #   2019-10-04 11:59:18 - xen/sched: move per-cpu variable cpupool to struct sched_resource
backport-c4598b3d945b.patch #   2019-10-04 11:59:45 - xen/sched: reject switching smt on/off with core scheduling active
backport-dad79946e552.patch #   2019-10-04 12:00:22 - xen/sched: prepare per-cpupool scheduling granularity
backport-2ea514e1b8c9.patch #   2019-10-04 12:00:47 - xen/sched: split schedule_cpu_switch()
backport-2fc635436958.patch #   2019-10-04 12:01:26 - xen/sched: protect scheduling resource via rcu
backport-95111283c19f.patch #   2019-10-04 12:01:52 - xen/sched: support multiple cpus per scheduling resource
backport-1ec410112cdd.patch #   2019-10-04 12:02:15 - xen/sched: support differing granularity in schedule_cpu_[add/rm]()
backport-cb563d7665f2.patch #   2019-10-04 12:02:41 - xen/sched: support core scheduling for moving cpus to/from cpupools
backport-c5d54d93a00b.patch #   2019-10-04 12:03:07 - xen/sched: disable scheduling when entering ACPI deep sleep states
backport-ae347ccc4202.patch #   2019-10-04 12:03:43 - xen/sched: add scheduling granularity enum
backport-b8ab1edad7d6.patch #   2019-10-04 12:04:28 - docs: add "sched-gran" boot parameter documentation
backport-969f58bde272.patch #   2019-10-07 11:19:54 - xen/sched: let credit scheduler control its timer all alone

################################################################################
# Patches for upstream
#

# late ucode loading fixes/changes
0007-microcode-intel-Writeback-and-invalidate-caches-befo.patch
0003-xen-microcode-add-information-about-currently-loaded.patch
0004-microcode-add-sequential-application-policy.patch
0007-microcode-update-raw-cpuid-policy-after-a-successful.patch
0001-microcode-remove-panic-calls.patch

detect-nehalem-c-state.patch # malcolmc
quirk-hp-gen8-rmrr.patch # malcolmc
quirk-pci-phantom-function-devices.patch # malcolmc

# Hpet improvements v5
0001-x86-hpet-Pre-cleanup.patch
0002-x86-hpet-Use-singe-apic-vector-rather-than-irq_descs.patch
0003-x86-hpet-Post-cleanup.patch

0002-libxc-retry-shadow-ops-if-EBUSY-is-returned.patch

# Grant perf improvements
avoid-gnt-unmap-tlb-flush-if-not-accessed.patch

# Further MB2/EFI fixes
0002-efi-Ensure-incorrectly-typed-runtime-services-get-ma.patch
0001-x86-time-Don-t-use-EFI-s-GetTime-call.patch
0001-efi-Workaround-page-fault-during-runtime-service.patch

0001-x86-HVM-Avoid-cache-flush-operations-during-hvm_load.patch # rossla - CA-168080
0001-libxl-Don-t-insert-PCI-device-into-xenstore-for-HVM-.patch # rossla - CA-168029

# PoD extra mitigations
0001-x86-PoD-Command-line-option-to-prohibit-any-PoD-oper.patch

fail-on-duplicate-symbol.patch
livepatch-ignore-duplicate-new.patch
default-log-level-info.patch

# Reduce use of __LINE__
0001-lib-Add-a-generic-implementation-of-current_text_add.patch
0002-sched-Remove-dependency-on-__LINE__-for-release-buil.patch

# btrfs support for PV guests
pygrub-Ignore-GRUB2-if-statements.patch
libfsimage-Add-support-for-btrfs.patch

0001-xen-domctl-Implement-a-way-to-retrieve-a-domains-nom.patch

quiet-broke-irq-affinity.patch # rossla
quirk-intel-purley.patch # rossla

# MSR policy
0001-x86-msr-Blacklist-various-MSRs-which-guests-definite.patch

# AVX-512
0001-Hide-AVX-512-from-guests-by-default.patch

# memory scrubbing
0001-common-page_alloc-don-t-idle-scrub-before-microcode-.patch

0001-xsm-hide-detailed-Xen-version-from-unprivileged-gues.patch

################################################################################
# Un-upstreamable patches
#
xen-tweak-cmdline-defaults.patch
xen-tweak-debug-overhead.patch
tweak-iommu-policy.patch
disable-core-parking.patch

0001-Allocate-space-in-structs-pre-emptively-to-increase-.patch

################################################################################
# Technical debt
#

# xen debt
livepatch-payload-in-header.patch
xen-define-offsets-for-kdump.patch
xen-scheduler-auto-privdom-weight.patch
xen-hvm-disable-tsc-ramping.patch
xen-default-cpufreq-governor-to-performance-on-intel.patch
xen-override-caching-cp-26562.patch
0001-Partially-revert-08754333892-hvmloader-limit-CPUs-ex.patch
0001-x86-pv-silently-discard-writes-into-MSR_AMD64_LS_CFG.patch # Remove when SSBD handling on AMD is reworked

# libxc debt
revert-ca2eee92df44.patch # 2008-09-30 09:14:54 - x86, hvm: Expose host core/HT topology to HVM guests - needs removing in a migrate-safe way.
libxc-stubs-hvm_check_pvdriver.patch

# pygrub debt
pygrub-add-default-and-extra-args.patch
pygrub-always-boot-default.patch
pygrub-friendly-no-fs.patch
pygrub-image-max-size.patch
pygrub-default-xenmobile-kernel.patch
pygrub-blacklist-support.patch

# BIOS debt
oem-bios-xensource.patch # Can probably all be discarded
oem-bios-magic-from-xenstore.patch # Need to tweak, but should be upstreamed

# misc debt
misc-log-guest-consoles.patch
fix-ocaml-libs.patch
ocaml-cpuid-helpers.patch

# xentop debt
xentop-vbd3.patch

# mixed between components
mixed-domain-runstates.patch
mixed-xc-sockets-per-core.patch
xenguest.patch
xen-vmdebug.patch

oxenstore-censor-sensitive-data.patch
oxenstore-large-packets.patch

# vGPU
nvidia-vga.patch

# workspace pod debt
hvmloader-disable-pci-option-rom-loading.patch

# Nested virt tweaking knobs
xen-force-software-vmcs-shadow.patch
0001-x86-vvmx-add-initial-PV-EPT-support-in-L0.patch
use-msr-ll-instead-of-vmcs-efer.patch

add-pv-iommu-headers.patch
add-pv-iommu-local-domain-ops.patch
add-pv-iommu-foreign-support.patch
add-pv-iommu-premap-m2b-support.patch
upstream-pv-iommu-tools.patch

# Intel GVT-g debt
allow-rombios-pci-config-on-any-host-bridge.patch
0007-hypercall-XENMEM_get_mfn_from_pfn.patch # Remove when PV-IOMMU code merged
gvt-g-hvmloader+rombios.patch # Intel to upstream

# VM Introspection Extensions
xen-introduce-cmdline-to-control-introspection-extensions.patch
xen-domctl-set-privileged-domain.patch
xen-reexecute-instn-under-monitor-trap.patch
revert-x86-mm-suppress-vm_events-caused-by-page-walks.patch
xen-emulate-Bypass-the-emulator-if-emulation-fails.patch
xen-introspection-pause.patch
xen-always-enable-altp2m-external-mode.patch

# Common Criteria
0001-cc-memory-scrubbing.patch

# Live microcode loading additions
0001-x86-add-XEN_SYSCTL_spec_ctrl.patch
0002-x86-add-xen-spec-ctrl-utility.patch

################################################################################
# Debugging patches
#
