#
# XenServer patch queue on top of xen.git
#    Upstream at git://xenbits.xen.org/xen.git
#
# In an effort to reduce future work of upgrading Xen versions, all patches in
# this queue require a justification as to why they can't/won't be upstreamed,
# with the implication that everything else should be upstreamed.
#
# If in any doubt, the ring0 patch queue maintainer will be happy to help.
#
# All patches should follow the guidelines listed here:
#       http://wiki.xen.org/wiki/Submitting_Xen_Patches
# in particular with respect to a description and S-o-b lines, with the
# exception of temporary debugging patches, which should contain at least a CA
# reference.
#
# Overview of sections:
# * XenServer build system integration.
#       **Minimal Upstream makefile hacks**
# * Upstream patches.
#       Verbatim patches from upstream, possibly with tweaks because of backporting
# * Patches for upstream.
#       Most patches should be in this section, especially new ones.  By using
#       this section, you are assuming responsibility for getting the patches
#       included upstream, and will be periodically chased by the patch queue
#       maintainer.
# * Un-upstreamable patches.
#       Default tweaks, etc.  Should be minimal.
# * Technical debt.
#       Legacy patches brought forward from the past.  This section should
#       never increase, and should progressively decrease.  **Remove when empty**
# * Debugging patches.
#       Temporary debugging patches, which must contain a CA reference.  Before
#       closing a ticket, you are expected to remove debugging patches.

################################################################################
# XenServer build system integration
#
build-tweaks.patch # Tweak version string, start-of-day banner and changeset
autoconf-libjson.patch

configure-build.patch # Configuration files for the build, including cached ./configure
changeset-info.patch
xenserver-configuration.patch
coverity-model.patch

################################################################################
# Upstream patches
#
# Naming scheme: backport-<12 digit SHA>.patch # [*] <UTC TIMESTAMP> - <Commit subject>
#   A '*' indicates a patch which should be suggested for backport upstream
revert-eval-nospec.patch # Breaks livepatch build

################################################################################
# Patches for upstream
#

# Core Scheduling from jgross1/sched-v3
0001-xen-sched-populate-cpupool0-only-after-all-cpus-are-.patch
0002-xen-sched-remove-cpu-from-pool0-before-removing-it.patch
0003-xen-sched-add-minimalistic-idle-scheduler-for-free-c.patch
0004-xen-sched-switch-to-debugtrace-in-cpupool-handling.patch
0005-xen-sched-rework-and-rename-vcpu_force_reschedule.patch
0006-xen-sched-use-new-sched_unit-instead-of-vcpu-in-sche.patch
0007-xen-sched-move-per-vcpu-scheduler-private-data-point.patch
0008-xen-sched-build-a-linked-list-of-struct-sched_unit.patch
0009-xen-sched-introduce-struct-sched_resource.patch
0010-xen-sched-let-pick_cpu-return-a-scheduler-resource.patch
0011-xen-sched-switch-schedule_data.curr-to-point-at-sche.patch
0012-xen-sched-move-per-cpu-scheduler-private-data-into-s.patch
0013-xen-sched-switch-vcpu_schedule_lock-to-unit_schedule.patch
0014-xen-sched-move-some-per-vcpu-items-to-struct-sched_u.patch
0015-xen-sched-add-scheduler-helpers-hiding-vcpu.patch
0016-xen-sched-rename-scheduler-related-perf-counters.patch
0017-xen-sched-switch-struct-task_slice-from-vcpu-to-sche.patch
0018-xen-sched-add-is_running-indicator-to-struct-sched_u.patch
0019-xen-sched-make-null-scheduler-vcpu-agnostic.patch
0020-xen-sched-make-rt-scheduler-vcpu-agnostic.patch
0021-xen-sched-make-credit-scheduler-vcpu-agnostic.patch
0022-xen-sched-make-credit2-scheduler-vcpu-agnostic.patch
0023-xen-sched-make-arinc653-scheduler-vcpu-agnostic.patch
0024-xen-add-sched_unit_pause_nosync-and-sched_unit_unpau.patch
0025-xen-let-vcpu_create-select-processor.patch
0026-xen-sched-use-sched_resource-cpu-instead-smp_process.patch
0027-xen-sched-switch-schedule-from-vcpus-to-sched_units.patch
0028-xen-sched-switch-sched_move_irqs-to-take-sched_unit-.patch
0029-xen-switch-from-for_each_vcpu-to-for_each_sched_unit.patch
0030-xen-sched-add-runstate-counters-to-struct-sched_unit.patch
0031-xen-sched-Change-vcpu_migrate_-to-operate-on-schedul.patch
0032-xen-sched-move-struct-task_slice-into-struct-sched_u.patch
0033-xen-sched-add-code-to-sync-scheduling-of-all-vcpus-o.patch
0034-xen-sched-introduce-unit_runnable_state.patch
0035-xen-sched-add-support-for-multiple-vcpus-per-sched-u.patch
0036-xen-sched-modify-cpupool_domain_cpumask-to-be-an-uni.patch
0037-xen-sched-support-allocating-multiple-vcpus-into-one.patch
0038-xen-sched-add-a-percpu-resource-index.patch
0039-xen-sched-add-fall-back-to-idle-vcpu-when-scheduling.patch
0040-xen-sched-make-vcpu_wake-and-vcpu_sleep-core-schedul.patch
0041-xen-sched-carve-out-freeing-sched_unit-memory-into-d.patch
0042-xen-sched-move-per-cpu-variable-scheduler-to-struct-.patch
0043-xen-sched-move-per-cpu-variable-cpupool-to-struct-sc.patch
0044-xen-sched-reject-switching-smt-on-off-with-core-sche.patch
0045-xen-sched-prepare-per-cpupool-scheduling-granularity.patch
0046-xen-sched-split-schedule_cpu_switch.patch
0047-xen-sched-protect-scheduling-resource-via-rcu.patch
0048-xen-sched-support-multiple-cpus-per-scheduling-resou.patch
0049-xen-sched-support-differing-granularity-in-schedule_.patch
0050-xen-sched-support-core-scheduling-for-moving-cpus-to.patch
0051-xen-sched-disable-scheduling-when-entering-ACPI-deep.patch
0052-xen-sched-add-scheduling-granularity-enum.patch

# v10 + v7 late ucode series from Chao Gao (Intel)
0001-microcode-split-out-apply_microcode-from-cpu_request.patch
0002-microcode-unify-ucode-loading-during-system-bootup-a.patch
0003-microcode-reduce-memory-allocation-and-copy-when-cre.patch
0007-microcode-intel-Writeback-and-invalidate-caches-befo.patch
0008-x86-microcode-Synchronize-late-microcode-loading.patch
0009-microcode-remove-microcode_update_lock.patch
# local fixes/changes (to be applied onto v7)
0003-xen-microcode-add-information-about-currently-loaded.patch
0004-microcode-add-sequential-application-policy.patch
0007-microcode-update-raw-cpuid-policy-after-a-successful.patch
0001-microcode-remove-panic-calls.patch

detect-nehalem-c-state.patch # malcolmc
quirk-hp-gen8-rmrr.patch # malcolmc
quirk-pci-phantom-function-devices.patch # malcolmc

# Hpet improvements v5
0001-x86-hpet-Pre-cleanup.patch
0002-x86-hpet-Use-singe-apic-vector-rather-than-irq_descs.patch
0003-x86-hpet-Post-cleanup.patch

0002-libxc-retry-shadow-ops-if-EBUSY-is-returned.patch

# Grant perf improvements
avoid-gnt-unmap-tlb-flush-if-not-accessed.patch

# Further MB2/EFI fixes
0002-efi-Ensure-incorrectly-typed-runtime-services-get-ma.patch
0001-x86-time-Don-t-use-EFI-s-GetTime-call.patch
0001-efi-Workaround-page-fault-during-runtime-service.patch

0001-x86-HVM-Avoid-cache-flush-operations-during-hvm_load.patch # rossla - CA-168080
0001-libxl-Don-t-insert-PCI-device-into-xenstore-for-HVM-.patch # rossla - CA-168029

# PoD extra mitigations
0001-x86-PoD-Command-line-option-to-prohibit-any-PoD-oper.patch

fail-on-duplicate-symbol.patch
livepatch-ignore-duplicate-new.patch
default-log-level-info.patch

# Reduce use of __LINE__
0001-lib-Add-a-generic-implementation-of-current_text_add.patch
0002-sched-Remove-dependency-on-__LINE__-for-release-buil.patch

# btrfs support for PV guests
pygrub-Ignore-GRUB2-if-statements.patch
libfsimage-Add-support-for-btrfs.patch

0001-xen-domctl-Implement-a-way-to-retrieve-a-domains-nom.patch

quirk-intel-purley.patch # rossla

# MSR policy
0001-x86-msr-Blacklist-various-MSRs-which-guests-definite.patch

# AVX-512
0001-Hide-AVX-512-from-guests-by-default.patch

# memory scrubbing
0001-common-page_alloc-don-t-idle-scrub-before-microcode-.patch

0001-xsm-hide-detailed-Xen-version-from-unprivileged-gues.patch

0001-x86-shim-fix-ballooning-down-the-guest.patch

################################################################################
# Un-upstreamable patches
#
xen-tweak-cmdline-defaults.patch
xen-tweak-debug-overhead.patch
tweak-iommu-policy.patch
disable-core-parking.patch

0001-Allocate-space-in-structs-pre-emptively-to-increase-.patch

################################################################################
# Technical debt
#

# xen debt
livepatch-payload-in-header.patch
xen-define-offsets-for-kdump.patch
xen-scheduler-auto-privdom-weight.patch
xen-hvm-disable-tsc-ramping.patch
xen-default-cpufreq-governor-to-performance-on-intel.patch
xen-override-caching-cp-26562.patch
0001-Partially-revert-08754333892-hvmloader-limit-CPUs-ex.patch
0001-x86-pv-silently-discard-writes-into-MSR_AMD64_LS_CFG.patch # Remove when SSBD handling on AMD is reworked

# libxc debt
revert-ca2eee92df44.patch # 2008-09-30 09:14:54 - x86, hvm: Expose host core/HT topology to HVM guests - needs removing in a migrate-safe way.
libxc-stubs-hvm_check_pvdriver.patch

# pygrub debt
pygrub-add-default-and-extra-args.patch
pygrub-always-boot-default.patch
pygrub-friendly-no-fs.patch
pygrub-image-max-size.patch
pygrub-default-xenmobile-kernel.patch
pygrub-blacklist-support.patch

# BIOS debt
oem-bios-xensource.patch # Can probably all be discarded
oem-bios-magic-from-xenstore.patch # Need to tweak, but should be upstreamed

# misc debt
misc-log-guest-consoles.patch
fix-ocaml-libs.patch
ocaml-cpuid-helpers.patch

# xentop debt
xentop-vbd3.patch

# mixed between components
mixed-domain-runstates.patch
mixed-xc-sockets-per-core.patch
xenguest.patch
xen-vmdebug.patch

oxenstore-censor-sensitive-data.patch
oxenstore-large-packets.patch

# vGPU
nvidia-vga.patch

# workspace pod debt
hvmloader-disable-pci-option-rom-loading.patch

# Nested virt tweaking knobs
xen-force-software-vmcs-shadow.patch
0001-x86-vvmx-add-initial-PV-EPT-support-in-L0.patch
use-msr-ll-instead-of-vmcs-efer.patch

add-pv-iommu-headers.patch
add-pv-iommu-local-domain-ops.patch
add-pv-iommu-foreign-support.patch
add-pv-iommu-premap-m2b-support.patch
upstream-pv-iommu-tools.patch

# Intel GVT-g debt
allow-rombios-pci-config-on-any-host-bridge.patch
0007-hypercall-XENMEM_get_mfn_from_pfn.patch # Remove when PV-IOMMU code merged
gvt-g-hvmloader+rombios.patch # Intel to upstream

# VM Introspection Extensions
xen-introduce-cmdline-to-control-introspection-extensions.patch
xen-domctl-set-privileged-domain.patch
xen-reexecute-instn-under-monitor-trap.patch
revert-x86-mm-suppress-vm_events-caused-by-page-walks.patch
xen-emulate-Bypass-the-emulator-if-emulation-fails.patch
xen-introspection-pause.patch
xen-always-enable-altp2m-external-mode.patch

# Common Criteria
0001-cc-memory-scrubbing.patch

# Live microcode loading additions
0001-x86-add-XEN_SYSCTL_spec_ctrl.patch
0002-x86-add-xen-spec-ctrl-utility.patch

################################################################################
# Debugging patches
#
