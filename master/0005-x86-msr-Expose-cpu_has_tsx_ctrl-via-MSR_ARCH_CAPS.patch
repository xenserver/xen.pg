From 968c822e91a5ca1b42fe49fb58eedc240c6734e6 Mon Sep 17 00:00:00 2001
From: Andrew Cooper <andrew.cooper3@citrix.com>
Date: Thu, 31 Oct 2019 20:27:11 +0000
Subject: x86/msr: Expose cpu_has_tsx_ctrl via MSR_ARCH_CAPS

Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>

diff --git a/xen/lib/x86/msr.c b/xen/lib/x86/msr.c
index 7d71e92a38..80cc5684bc 100644
--- a/xen/lib/x86/msr.c
+++ b/xen/lib/x86/msr.c
@@ -39,7 +39,18 @@ int x86_msr_copy_to_buffer(const struct msr_policy *p,
     })
 
     COPY_MSR(MSR_INTEL_PLATFORM_INFO, p->platform_info.raw);
-    COPY_MSR(MSR_ARCH_CAPABILITIES,   p->arch_caps.raw);
+
+#ifdef __XEN__
+    /*
+     * When requesting the Host MSR policy, feed back cpu_has_tsx_ctrl in its
+     * architectural position in MSR_ARCH_CAPS, so the toolstack can evaluate
+     * whether a VM migrating in having seen TSX is safe to run.
+     */
+    if ( p == &host_msr_policy && cpu_has_tsx_ctrl == 1 )
+        COPY_MSR(MSR_ARCH_CAPABILITIES, ARCH_CAPS_TSX_CTRL);
+    else
+#endif
+        COPY_MSR(MSR_ARCH_CAPABILITIES,   p->arch_caps.raw);
 
 #undef COPY_MSR
 
