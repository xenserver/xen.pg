From 03485312488c8ca65b08f2bd44ab00383a599cea Mon Sep 17 00:00:00 2001
From: Sergey Dyasli <sergey.dyasli@citrix.com>
Date: Tue, 26 Jun 2018 09:39:27 +0100
Subject: [PATCH] Hide AVX-512 from guests by default

It can be enabled by providing "cpuid=avx512" in Xen's cmdline.

Signed-off-by: Sergey Dyasli <sergey.dyasli@citrix.com>
diff --git a/xen/arch/x86/cpuid.c b/xen/arch/x86/cpuid.c
index 954043d4f177..db22f99dd6d4 100644
--- a/xen/arch/x86/cpuid.c
+++ b/xen/arch/x86/cpuid.c
@@ -19,6 +19,8 @@ static const uint32_t hvm_shadow_featuremask[] = INIT_HVM_SHADOW_FEATURES;
 static const uint32_t hvm_hap_featuremask[] = INIT_HVM_HAP_FEATURES;
 static const uint32_t deep_features[] = INIT_DEEP_FEATURES;
 
+bool __initdata opt_avx512 = false;
+
 static int __init parse_xen_cpuid(const char *s)
 {
     const char *ss;
@@ -69,6 +71,8 @@ static int __init parse_xen_cpuid(const char *s)
                 {
                     if ( strcmp(mid->name, "doitm") == 0 )
                         opt_doitm = val;
+                    else if ( strcmp(mid->name, "avx512") == 0 )
+                        opt_avx512 = val;
                 }
                 else if ( !val )
                     setup_clear_cpu_cap(mid->bit);
diff --git a/xen/arch/x86/setup.c b/xen/arch/x86/setup.c
index f0ba7f59d777..8680937059b5 100644
--- a/xen/arch/x86/setup.c
+++ b/xen/arch/x86/setup.c
@@ -1634,6 +1634,9 @@ void __init noreturn __start_xen(unsigned long mbi_p)
     if ( opt_invpcid && cpu_has_invpcid )
         use_invpcid = true;
 
+    if ( !opt_avx512 )
+        setup_clear_cpu_cap(X86_FEATURE_AVX512F);
+
     init_speculation_mitigations();
 
     init_idle_domain();
diff --git a/xen/include/asm-x86/cpuid.h b/xen/include/asm-x86/cpuid.h
index 6c0c40378817..a7ca8139f532 100644
--- a/xen/include/asm-x86/cpuid.h
+++ b/xen/include/asm-x86/cpuid.h
@@ -13,6 +13,8 @@
 
 #include <public/sysctl.h>
 
+extern bool opt_avx512;
+
 extern const uint32_t known_features[FSCAPINTS];
 extern const uint32_t special_features[FSCAPINTS];
 
diff --git a/xen/tools/gen-cpuid.py b/xen/tools/gen-cpuid.py
index 21928efab7cb..67eba9e575dc 100755
--- a/xen/tools/gen-cpuid.py
+++ b/xen/tools/gen-cpuid.py
@@ -302,6 +302,9 @@ def crunch_numbers(state):
     pseduo_names = (
         # Data Operand Invariant Timing Mode.  Lives in MSR_ARCH_CAPS
         "doitm",
+
+        # AVX512
+        "avx512",
     )
 
     for n in pseduo_names:
